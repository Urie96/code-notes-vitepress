---
title: 旁路由通过配置iptables和Clash实现局域网全设备无感知透明代理
date: 2022-11-03 19:34:35 GMT+0800
categories: [家庭服务]
tags: [iptables, Clash, Proxy]
---

::: abstract
之前的局域网代理方案是在树莓派上运行`v2ray`对外提供 HTTP 代理和 SOCKS5 代理，然后在其它设备上挨个配置 WIFI 的 HTTP 代理，如果是终端就在需要代理的时候配置`http_proxy`环境变量。但是会遇到有些软件不尊重系统的代理环境变量，或者有些底层设备配置代理很麻烦甚至不支持配置，这时候就需要网关来实现透明代理了。
:::

<!-- more -->

## 树莓派上运行 Clash

### Clash 配置

```yaml
# /etc/clash/config.yaml
redir-port: 7892
mixed-port: 7890 # HTTP(S) and SOCKS4(A)/SOCKS5 server on the same port
allow-lan: true
bind-address: '*'
mode: rule
log-level: warning
ipv6: false
external-controller: 0.0.0.0:9090
external-ui: clash-dashboard
secret: '123'
hosts:
  +.cro.cab: 192.168.1.7
profile:
  store-selected: false
  store-fake-ip: true
dns:
  enable: true
  listen: 0.0.0.0:53
  # ipv6: false # when the false, response to AAAA questions will be empty
  default-nameserver:
    - 114.114.114.114
    - 8.8.8.8
  enhanced-mode: fake-ip # or redir-host (not recommended)
  fake-ip-range: 198.18.0.1/16 # Fake IP addresses pool CIDR
  nameserver:
    - 114.114.114.114 # default value
    - 8.8.8.8 # default value
proxies:
  - name: 'vmess-hk'
    type: vmess
    ...

proxy-groups:
  - name: Proxy
    type: select
    proxies:
      - vmess-hk
      - vmess-us

rules:
  - DOMAIN-SUFFIX,google.com,Proxy
  - DOMAIN-KEYWORD,google,Proxy
  - DOMAIN,google.com,Proxy
  - DOMAIN-SUFFIX,ad.com,REJECT
  - SRC-IP-CIDR,192.168.1.201/32,DIRECT
  - IP-CIDR,127.0.0.0/8,DIRECT
  - GEOIP,CN,DIRECT
  - MATCH,Proxy
```

::: tip Note

DNS 的 fake-ip 的作用是将所有域名解析为假 IP，同时代理客户端（这里即指 Clash）会保存所有假 IP 到真实域名的映射，在代理 TCP 请求时，假 IP 被替换为真实域名，由代理服务端进行 DNS 解析，请求源端和代理客户端均不感知域名的真实 IP。但是在配置规则时如果添加了基于 IP 的规则（比如上面基于 IP 地理位置的分流），则代理客户端需要解析真实 IP。

:::

Systemd 服务配置：

```ini
# /etc/systemd/system/clash.service
[Unit]
Description=Clash daemon, A rule-based proxy in Go.
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=/usr/local/bin/clash -d /etc/clash

[Install]
WantedBy=multi-user.target
```

```terminal
$ sudo systemctl daemon-reload
$ sudo systemctl start clash
$ sudo systemctl enable clash
Created symlink /etc/systemd/system/multi-user.target.wants/clash.service → /etc/systemd/system/clash.service.
$ cat /etc/resolv.conf # 配置 DNS 为 Clash 的 DNS 服务
# Generated by resolvconf
nameserver 192.168.1.7
nameserver 192.168.1.1
nameserver fe80::1%eth0
$ ping baidu.com # DNS返回了假IP，但是ICMP包没有走代理所以假IP是Ping不通的
PING baidu.com (198.18.0.9) 56(84) bytes of data.
^C
--- baidu.com ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 28ms

$ http_proxy=http://127.0.0.1:7890 curl google.com # 可以通过环境变量上网了
<HTML><HEAD><meta http-equiv="content-type" content="text/html;charset=utf-8">
<TITLE>301 Moved</TITLE></HEAD><BODY>
<H1>301 Moved</H1>
The document has moved
<A HREF="http://www.google.com/">here</A>.
</BODY></HTML>
```

配置 iptables 配置开机执行，避免重启失效：

```terminal
$ cat <<EOF | sudo tee -a /etc/rc.local
iptables -t nat -N CLASH # 给nat表新增一个名为 CLASH 的链
iptables -t nat -A CLASH -d 10.0.0.0/8 -j RETURN
iptables -t nat -A CLASH -d 127.0.0.0/8 -j RETURN
iptables -t nat -A CLASH -d 169.254.0.0/16 -j RETURN
iptables -t nat -A CLASH -d 172.16.0.0/12 -j RETURN
iptables -t nat -A CLASH -d 192.168.0.0/16 -j RETURN
iptables -t nat -A CLASH -d 224.0.0.0/4 -j RETURN
iptables -t nat -A CLASH -d 240.0.0.0/4 -j RETURN
iptables -t nat -A CLASH -p tcp -j REDIRECT --to-ports 7892 # 到这一步还没return就全走代理
iptables -t nat -I PREROUTING -p tcp -j CLASH # 在 PREROUTING 链的最前面插入 CLASH 链
sysctl -w net.ipv4.ip_forward=1 # 允许路由转发
EOF
```

::: tip

iptables 的链可以简单理解为一个函数：

```go
func ClashRoute(req) {
  if req.ip == LocalAddress {
    return
  }
  if req.ip == LoopbackAddress {
    return
  }
  RedirectToProxy(req)
}
func PREROUTING(req) {
  ClashRoute(req)
  OtherDirectRoute(req)
  ...
}
```

:::

这时候树莓派就配置好了，接下来将局域网设备的网关和 DNS 配置为树莓派的 IP 就行。

```plantuml
title 我家里的网络结构
node node1 as "光猫 192.168.1.1"
node node2 as "PC 192.168.1.2"
node node3 as "树莓派 192.168.1.7"
node node4 as "路由器 192.168.50.1"
node node5 as "手机 192.168.50.244"
node node6 as "电视盒子 192.168.50.243"
node1 <-- node2
node1 <-- node3
node1 <-- node4 : 192.168.1.20
node4 <-- node5
node4 <-- node6
```

对于 PC，可以在网络设置中将网关和 DNS 配置为树莓派的 IP，这样就可以通过树莓派上网了，如下图。

![](https://cdn.jsdelivr.net/gh/Urie96/images/20221104170218.jpg)

也可以给路由器手动配置 WAN 侧的网关和 DNS 为树莓派 IP，路由器 IP 和光猫在一个网段，这样这个路由器下的所有设备都自动走 Clash。

也可以配置 DHCP 服务，让局域网内的设备自动获取树莓派的 IP，最后这个方案我没试过。